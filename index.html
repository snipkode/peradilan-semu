<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Peradilan Semu Hukum Acara Perdata</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- Inter Font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 90%; /* Adjust as needed for larger screens */
            margin: 0 auto;
            padding: 1.5rem; /* Reduced padding */
        }
        .chat-bubble {
            max-width: 80%;
            border-radius: 0.75rem; /* rounded-xl */
            padding: 0.75rem 1rem; /* p-3 px-4 */
            margin-bottom: 0.75rem; /* mb-3 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .chat-bubble.user {
            background-color: #d1fae5; /* green-100 */
            align-self: flex-end; /* ml-auto */
        }
        .chat-bubble.system {
            background-color: #e0f2fe; /* blue-100 */
            align-self: flex-start; /* mr-auto */
        }
        /* Custom scrollbar for chat area */
        .chat-area::-webkit-scrollbar {
            width: 8px;
        }
        .chat-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .chat-area::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .chat-area::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            margin: 0.5rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .role-selected {
            border: 2px solid #2563eb; /* blue-600 */
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5); /* ring-2 ring-blue-500 */
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .container {
                max-width: 70%;
            }
        }
        @media (min-width: 1024px) {
            .container {
                max-width: 60%;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="container bg-white p-6 rounded-xl shadow-lg flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6">
        <!-- Left Panel: Scenario, Role Selection -->
        <div class="lg:w-1/2 flex flex-col space-y-6">
            <div class="bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Simulasi Peradilan Semu</h2>
                <p class="text-gray-700 leading-relaxed mb-4">Selamat datang di aplikasi simulasi peradilan semu hukum acara perdata. Aplikasi ini akan membantu Anda memahami dinamika persidangan dengan memainkan peran yang berbeda.</p>
                <div class="mt-4 p-4 bg-white rounded-lg border border-gray-300">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Skenario Kasus:</h3>
                    <p class="text-gray-600 text-sm">
                        Sebuah sengketa perdata antara Bapak Budi (Penggugat) dan Ibu Siti (Tergugat) mengenai wanprestasi perjanjian sewa-menyewa rumah. Bapak Budi mengklaim Ibu Siti belum membayar sewa selama 3 bulan, sementara Ibu Siti menyatakan rumah tersebut tidak layak huni dan Bapak Budi tidak pernah melakukan perbaikan.
                    </p>
                </div>
            </div>

            <!-- Role Selection -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Pilih Peran Anda:</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button class="role-button flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-sm hover:bg-blue-50 transition duration-200 border border-gray-300" data-role="Hakim">
                        <span class="text-4xl">üë®‚Äç‚öñÔ∏è</span>
                        <span class="mt-2 text-md font-medium text-gray-700">Hakim</span>
                    </button>
                    <button class="role-button flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-sm hover:bg-blue-50 transition duration-200 border border-gray-300" data-role="Penggugat">
                        <span class="text-4xl">üë®‚Äçüíº</span>
                        <span class="mt-2 text-md font-medium text-gray-700">Penggugat</span>
                    </button>
                    <button class="role-button flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-sm hover:bg-blue-50 transition duration-200 border border-gray-300" data-role="Tergugat">
                        <span class="text-4xl">üë©‚Äçüíº</span>
                        <span class="mt-2 text-md font-medium text-gray-700">Tergugat</span>
                    </button>
                    <button class="role-button flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-sm hover:bg-blue-50 transition duration-200 border border-gray-300" data-role="Saksi">
                        <span class="text-4xl">üó£Ô∏è</span>
                        <span class="mt-2 text-md font-medium text-gray-700">Saksi</span>
                    </button>
                </div>
                <p id="selected-role-display" class="mt-4 text-center text-lg font-medium text-gray-700">
                    Peran terpilih: <span class="font-semibold text-blue-600">Belum dipilih</span>
                </p>
            </div>
        </div>

        <!-- Right Panel: Chat Interface -->
        <div class="lg:w-1/2 flex flex-col space-y-6">
            <div class="flex-grow bg-gray-50 p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Jalannya Persidangan</h2>
                <div id="chat-area" class="chat-area flex-grow bg-white p-4 rounded-lg border border-gray-300 overflow-y-auto mb-4" style="height: 400px;">
                    <!-- Chat messages will appear here -->
                    <div class="chat-bubble system mr-auto">
                        <p class="text-sm text-gray-800"><span class="font-semibold text-blue-700">Hakim:</span> Selamat datang di persidangan kasus perdata nomor 123/Pdt.G/2025/PN Jkt. Selatan. Sidang hari ini adalah pemeriksaan awal. Saudara Penggugat, silakan sampaikan gugatan Anda.</p>
                    </div>
                </div>

                <div class="loading-spinner" id="loading-spinner"></div>

                <div class="mt-auto">
                    <label for="statement-input" class="block text-md font-medium text-gray-700 mb-2">Pernyataan Anda:</label>
                    <textarea id="statement-input" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y" placeholder="Ketik pernyataan Anda di sini..."></textarea>
                    <button id="submit-statement-button" class="mt-4 w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        Kirim Pernyataan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase configuration, initialized later
        let firebaseConfig = {
            apiKey: "AIzaSyBg17cVwN2RqFHfs5UW4p9hCAym8MRPMRk",
            authDomain: "sample-firebase-ai-app-f7271.firebaseapp.com",
            projectId: "sample-firebase-ai-app-f7271",
            storageBucket: "sample-firebase-ai-app-f7271.firebasestorage.app",
            messagingSenderId: "855997436295",
            appId: "1:855997436295:web:c9dfdeeb1309b88bc30322"
        };
        let __app_id = 'default-app-id'; // Fallback
        let __initial_auth_token = undefined; // Fallback

        // Initialize Firebase app and services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, db, auth, userId;
        let selectedRole = null;
        const chatHistory = [
            { role: "Hakim", text: "Selamat datang di persidangan kasus perdata nomor 123/Pdt.G/2025/PN Jkt. Selatan. Sidang hari ini adalah pemeriksaan awal. Saudara Penggugat, silakan sampaikan gugatan Anda." }
        ];

        $(document).ready(function() {
            // Check if global variables are defined by the Canvas environment
            if (typeof window.__firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(window.__firebase_config);
            }
            if (typeof window.__app_id !== 'undefined') {
                __app_id = window.__app_id;
            }
            if (typeof window.__initial_auth_token !== 'undefined') {
                __initial_auth_token = window.__initial_auth_token;
            }

            // Initialize Firebase only after the DOM is ready
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Sign in anonymously or with custom token
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase initialized and user signed in:", userId);
                    // Now that user is authenticated, you can safely interact with Firestore
                    // For this simple app, we don't strictly need Firestore persistence for chat
                    // but if we did, this is where we'd start fetching/listening for data.
                } else {
                    try {
                        if (__initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error signing in:", error);
                        // Fallback to a random ID if anonymous sign-in also fails
                        userId = crypto.randomUUID();
                    }
                    console.log("User ID:", userId);
                    // You could potentially display the userId on the UI for multi-user scenarios
                }
            });

            // Role selection logic
            $('.role-button').on('click', function() {
                $('.role-button').removeClass('role-selected bg-blue-100').addClass('bg-white');
                $(this).addClass('role-selected bg-blue-100');
                selectedRole = $(this).data('role');
                $('#selected-role-display').html(`Peran terpilih: <span class="font-semibold text-blue-600">${selectedRole}</span>`);
                $('#submit-statement-button').prop('disabled', false); // Enable submit button once role is selected
                $('#statement-input').prop('disabled', false); // Enable input field
            });

            // Disable submit button and input initially
            $('#submit-statement-button').prop('disabled', true);
            $('#statement-input').prop('disabled', true);

            // Function to add message to chat area
            function addMessageToChat(role, text, isUser = false) {
                const messageHtml = `
                    <div class="chat-bubble ${isUser ? 'user ml-auto' : 'system mr-auto'}">
                        <p class="text-sm text-gray-800"><span class="font-semibold ${isUser ? 'text-green-700' : 'text-blue-700'}">${role}:</span> ${text}</p>
                    </div>
                `;
                $('#chat-area').append(messageHtml);
                // Scroll to the bottom of the chat area
                $('#chat-area').scrollTop($('#chat-area')[0].scrollHeight);
            }

            // Handle statement submission
            $('#submit-statement-button').on('click', async function() {
                if (!selectedRole) {
                    // Replace alert with a custom message box or visual feedback
                    $('#statement-input').val(''); // Clear the input
                    // Example of a simple visual feedback (for demo purposes)
                    $('#selected-role-display').css('color', 'red').text('Pilih peran Anda terlebih dahulu!');
                    setTimeout(() => {
                        $('#selected-role-display').css('color', '').html(`Peran terpilih: <span class="font-semibold text-blue-600">Belum dipilih</span>`);
                    }, 3000);
                    return;
                }

                const userStatement = $('#statement-input').val().trim();
                if (userStatement === '') {
                    // Replace alert with a custom message box or visual feedback
                    $('#statement-input').addClass('border-red-500'); // Highlight empty input
                    setTimeout(() => {
                        $('#statement-input').removeClass('border-red-500');
                    }, 2000);
                    return;
                }

                addMessageToChat(selectedRole, userStatement, true);
                chatHistory.push({ role: selectedRole, text: userStatement });
                $('#statement-input').val(''); // Clear the input

                $('#loading-spinner').show(); // Show loading spinner
                $('#submit-statement-button').prop('disabled', true); // Disable button during API call

                try {
                    // Prepare chat history for LLM API call
                    const formattedChatHistory = chatHistory.map(msg => ({
                        role: msg.role === 'Hakim' ? 'model' : 'user', // Treat Hakim as model, others as user for simplicity
                        parts: [{ text: `${msg.role}: ${msg.text}` }]
                    }));

                    // Add a system instruction or a specific prompt for the LLM
                    const llmPrompt = `
                        Anda adalah asisten AI yang mensimulasikan peradilan semu hukum acara perdata.
                        Anda harus merespons sebagai 'Hakim', 'Penggugat', 'Tergugat', atau 'Saksi' berdasarkan konteks dan peran yang sedang berbicara, tetapi prioritas utama adalah menanggapi sebagai "Hakim" kecuali diminta secara spesifik oleh Penggugat/Tergugat/Saksi untuk merespons dari peran lain.
                        Tujuan Anda adalah menjaga alur persidangan dan memberikan respons yang relevan dengan hukum acara perdata.
                        Pertahankan respons Anda singkat, relevan, dan dalam bahasa Indonesia.
                        Berikut adalah riwayat percakapan sejauh ini:
                        ${formattedChatHistory.map(c => `${c.role}: ${c.parts[0].text}`).join('\n')}

                        Berdasarkan pernyataan terakhir dari ${selectedRole}: "${userStatement}", bagaimana Anda akan melanjutkan persidangan atau merespons sebagai peran yang paling sesuai (prioritaskan Hakim)?
                    `;


                    const payload = {
                        contents: [{ role: "user", parts: [{ text: llmPrompt }] }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 200
                        }
                    };

                    const apiKey = "AIzaSyA4p9orSNKzkVFOa0IAGca1GNqSFCg11vo"; // Canvas will automatically provide this at runtime
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    let llmResponseText = "Maaf, saya tidak bisa memberikan respons saat ini.";
                    let llmResponseRole = "Sistem";

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        llmResponseText = result.candidates[0].content.parts[0].text;

                        // Simple logic to extract role from LLM response if it starts with a known role
                        const roles = ["Hakim", "Penggugat", "Tergugat", "Saksi"];
                        for (const role of roles) {
                            if (llmResponseText.startsWith(`${role}:`)) {
                                llmResponseRole = role;
                                llmResponseText = llmResponseText.substring(`${role}:`.length).trim();
                                break;
                            }
                        }
                        // Default to Hakim if no specific role is found at the beginning
                        if (llmResponseRole === "Sistem") {
                            llmResponseRole = "Hakim";
                        }

                    } else {
                        console.error("Unexpected LLM response structure:", result);
                    }

                    addMessageToChat(llmResponseRole, llmResponseText, false);
                    chatHistory.push({ role: llmResponseRole, text: llmResponseText });

                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    addMessageToChat("Sistem", "Terjadi kesalahan saat memproses permintaan Anda. Silakan coba lagi.");
                } finally {
                    $('#loading-spinner').hide(); // Hide loading spinner
                    $('#submit-statement-button').prop('disabled', false); // Re-enable button
                }
            });
        });
    </script>
</body>
</html>
